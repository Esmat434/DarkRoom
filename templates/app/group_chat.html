{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        body{
            background-color: black;
        }
    </style>
    <title>Chat</title>
</head>
<body>
    <!-- this is from header -->
    <div class="card" style="position: relative;padding: 10px;height: 90px;background-color: black;box-shadow: rgba(5, 44, 184, 0.27) 0px 0px 1em, rgba(6, 87, 239, 0.05) 0px 0.25em 1em;">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-9">
                    <div class="card rounded-circle d-inline-block me-5" style="width: 70px; height: 70px;background-image: url('{{avatar.url}}');background-position: center;background-repeat: no-repeat;background-size: cover;"></div>
                    <span style="position: absolute;left: 120px; top: 20px;">{{groupname}}</span>
                </div>
                <div class="col-lg-1 mt-4">
                    <a href="/Home/{{id}}/{{username}}/Group/" class="btn btn-danger btn-sm mb-4 block-btn ms-4">block</a>
                </div>
                <div class="col-lg-2 mt-4">
                    <div class="btn btn-danger btn-sm clear-btn">Clear Chat</div>
                </div>
            </div>
        </div>
    </div>

    <!-- this is for put the messages -->
    <div class="container-fluid con1 mt-2" style="height: 75vh;overflow: auto;">

    </div>

    <!-- this is for wirte and send messages -->
    <div class="container-fluid" style="position: fixed;">
        <div class="row">
            <div class="col-lg-11">
                <input type="text" placeholder="Enter Your message" class="form-control message" style="border-radius: 20px;">
            </div>
            <div class="col-lg-1">
                <div class="btn btn-success button"><i class="fa fa-paper-plane"></i></div>
            </div>
        </div>
    </div>
    <script>
        const id = '{{id}}'
        const username = '{{username}}'
        const groupname = '{{groupname}}'
        const container = document.querySelector(".con1")
        const block_btn = document.querySelector(".block-btn")
        const clear_btn = document.querySelector(".clear-btn")
        const message_input = document.querySelector(".message")
        const btn = document.querySelector('.button')
        const chatSocket = new WebSocket('ws://'+document.location.host + '/ws/Home/' + id + '/' + username + '/' + groupname+ '/')

        chatSocket.onopen = function(e){
            console.log('Websocket is open')
        }

        btn.addEventListener("click",()=>{
            const message = message_input.value

            const data = JSON.stringify({
                action:'message',
                message:message
            })

            chatSocket.send(data)
            message_input.value = ''
            document.location.reload()
        })  
        
        block_btn.addEventListener("click",()=>{
            const data = JSON.stringify({
                action:'block',
                message:'None'
            })

            chatSocket.send(data)
            console.log('data sended: ',data)
            window.location.reload()
        })

        message_input.addEventListener("keydown",(e)=>{
            if (e.key === 'Enter'){
                const msg_data = message_input.value
                const data = JSON.stringify({
                    action:'message',
                    message:msg_data
                })

                chatSocket.send(data)
                window.location.reload()
            }
        })

        clear_btn.addEventListener("click",()=>{
            const data = JSON.stringify({
                action:'clear',
                message:''
            })

            chatSocket.send(data)
            window.location.reload()
        })

        chatSocket.onmessage = function(e){
            const data = JSON.parse(e.data)
            messages = data.message
            time = data.time
            const name = data.name
            const Element = document.createElement('div')
            Element.classList.add('d-flex')
            Element.classList.add('justify-content-start')
            const element1 = document.createElement('div')

            element1.style.maxWidth = '75%'
            element1.style.padding = '10px'
            element1.style.borderRadius = '15px'
            element1.style.marginBottom = '10px'
            if (username === name){
                element1.style.backgroundColor = 'green'
            }else{
                element1.style.backgroundColor = '#f1f0f0'
            }
            element1.textContent = messages
            const element3 = document.createElement('p')
            element3.classList.add('small')
            element3.classList.add('text-muted')
            element3.style.fontSize = '8px'
            element3.textContent = time
            element1.appendChild(element3)
            const element2 = document.createElement('span')
            element2.textContent = name
            element2.style.fontSize = '10px'
            element2.style.fontWeight = 'bold'
            element2.style.color = 'red'
            element2.style.cursor = 'pointer'
            Element.appendChild(element2)
            Element.appendChild(element1)
            container.appendChild(Element)

            element2.addEventListener("click",()=>{
                const data = JSON.stringify({
                    action:'delete',
                    message:element1.textContent,
                    time:element3.textContent
                })

                chatSocket.send(data)
                window.location.reload()
            })

        }

        chatSocket.onclose = function(e){
            console.log('Websocket is closed: ',e)
        }
    </script>
</body>
</html>